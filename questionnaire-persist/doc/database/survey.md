# 调查相关的表
## 最开始的表结构
最初我计划的表结构为:

![最初的表结构](./image/originalDatabase.png)

这样的数据表结构应该是很好想出来的. 感觉比较符合在数据库课上学的, 每个实体对应一张表, 每个属性对应一列. 咋一看, 挺好的. 程序可以这样写:

1. 用户点击添加链接
2. 跳转到添加问题页面, 用户填写相关的信息
3. 保存问题到数据库, 跳到设计问卷页面.

但是这样做体验应该是很不好的吧?
当然可以使用ajax:

1. 用户点击添加链接
2. 动态生成一个div, 由用户来填写相关的信息
3. 完成编辑, 通过ajax发送到后台
4. 存储到数据库, 并将id返回给前台
5. 前台接收id, 以后用户再做修改直接通过id向后台发送ajax

但是, 在第3步和第5步之间是有时间间隔的, 如果网速很慢, 那么间隔可能会很大. 如果当中用户修改了数据, 实际上是没法提交的, 因为没有id. 所以需要等待回传的id. 当然, 由于每创建一个问题都需要一次数据库交互, 所以, 访问频率可能太高了. 如果需要使用批量添加, 那么比上面的还麻烦.

这样的表结构的问题有两点:

- 前台需要维护题目是否已经有id值了等状态, 然后向服务器发送数据时, 要携带添加、 修改 和 删除 等信息. 而后台也需要根据这些信息去进行不同的处理.
- 删除问卷时, 需要删除与之关联的回答, 级联删除的层数有点太多了吧? 效率上是否有点低了.

## 修改后的表结构

我把表结构修改成了下面这样:

![修改后的表结构](./image/modifyDatabase.png)

原因如下:

- 虽然每个问题都可以作为一个单独的个体. 但是, 在这里应该不会去单独去查询某个问题, 最少也是去查询某个页面.  同理, 我们不会去查询某个一问题的某个答案, 而是去统计一个调查问卷的所有答案. 也就是说, 页面 和 一次回答的答案 才是查询的基本单位.
- 每个问题都没有自己的id. 所以, 我们不需要去维护id等信息. 虽然页面也有id, 但是比较少, 相对而言比较好维护. 而且由于页面的数量比较少, 所以可以通过一些方法不去维护id.
- 在删除的时候, 级联删除的层数不是太多, 效率上应该是有所提高的.

**缺点**

- 这样的表结构在使用增量更新的时候, 服务器端可能需要进行一些比较复杂的处理, 但是应该是可以进行批量更新的
- 这样的表结构导致`page`表的`rank`字段 和 `answer`表的`answer`字段有可能会很长, 虽然使用了`text`类型, 还是存在字段不够长的情况. 但是大多数情况下应该还是可以应付. 所以先这样处理.
- 在进行更复杂的统计时, 只能使用`like`去进行查询, 可能会出现一些效率问题. 这个由于比较复杂的统计用的几率可能并不是太大. 而且实际上参与调查的人可能也不是特别的多. 如果太慢全文索引也有可能有帮助. 这个问题也只能暂时放一放.

## `page`表的`question`的结构
由于一个页面有多个问题, 所以这里说明一下存储的格式:

**(页面信息)(QUESTION\_START)** 或者 **(页面信息)(QUESTION\_START)(问题)[(QUESTION\_EXCISION)(问题)]**

也就是说以页面信息开始, 接着是分割符, 最后是n个问题, 每个问题之间使用(QUESTION_EXCISION)作为分割符. 下面给出页面信息和问题的格式:

- 页面信息: **(标题)(QUESTION\_MODULE)(次序)(QUESTION\_MODULE)(其他信息)**
- 问题: **(问题)(QUESTION\_MODULE)([选项等信息])(QUESTION\_MODULE)(其他信息)**
- 各个模块如果还需要分割的话, 可以使用 **(MODULE\_EXCISION)** 进行分割

其中:

- **QUESTION\_START 为 `ASCII` 码 `2` 对应的字符 或者说是 `\u0002`**
- **QUESTION\_EXCISION 为 `ASCII` 码 `1D` 对应的字符 或者说是 `\u001D`**
- **QUESTION\_MODULE 为 `ASCII` 码 `1E` 对应的字符 或者说是 `\u001E`**
- **MODULE\_EXCISION 为 `ASCII` 码 `1F` 对应的字符 或者说是 `\u001F`**
